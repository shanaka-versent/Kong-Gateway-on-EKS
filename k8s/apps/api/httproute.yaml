# Users API HTTPRoute with Kong Plugins
# @author Shanaka Jayasundera - shanakaj@gmail.com
#
# Routes /api/users/* paths to the users-api service.
# Applies Kong plugins for rate limiting and request transformation.

apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: users-api-route
  namespace: api
  annotations:
    # Kong plugins to apply to this route
    konghq.com/plugins: "rate-limiting,request-transformer,cors"
spec:
  parentRefs:
    - name: kong-gateway
      namespace: kong
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /api/users
      backendRefs:
        - name: users-api
          port: 8080

---
# ReferenceGrant allows Kong Gateway to route to services in api namespace
apiVersion: gateway.networking.k8s.io/v1beta1
kind: ReferenceGrant
metadata:
  name: allow-kong-gateway
  namespace: api
spec:
  from:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      namespace: api
  to:
    - group: ""
      kind: Service
