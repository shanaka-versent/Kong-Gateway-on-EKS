# Kong Konnect Integration - Reference Values
# @author Shanaka Jayasundera - shanakaj@gmail.com
#
# SPLIT DEPLOYMENT: Kong Gateway (data plane) and KIC (controller) are deployed
# as separate Helm releases. Only KIC connects to Konnect.
#
# These values are for reference only — the actual config is inline in:
#   - argocd/apps/02-kong-gateway.yaml    (data plane — no Konnect config)
#   - argocd/apps/02b-kong-controller.yaml (KIC + Konnect config sync)
#
# IMPORTANT: For KIC-type control planes (CLUSTER_TYPE_K8S_INGRESS_CONTROLLER),
# KIC handles ALL Konnect communication — config sync, node registration, and
# license fetch. The data plane does NOT connect to Konnect directly.
#
# KONNECT ANALYTICS LIMITATION (KIC + Gateway Discovery pattern):
# Native Konnect analytics requires role=data_plane to activate the telemetry
# subsystem. However, role=data_plane forcefully disables the admin API — even
# with explicit admin_listen override — which breaks KIC gateway discovery.
# This is a fundamental Kong architectural limitation. Tested and confirmed:
#   - role=data_plane → admin API killed → KIC can't push config → routes fail
#   - admin_listen override with role=data_plane → STILL disabled
#   - konnect_mode=on without role=data_plane → telemetry subsystem NOT activated
#
# API observability is provided via the Prometheus plugin instead
# (see k8s/kong/prometheus-plugin.yaml for global metrics collection).

# ==============================================================================
# DATA PLANE VALUES (argocd/apps/02-kong-gateway.yaml)
# ==============================================================================
# The data plane handles traffic proxying, TLS termination, and plugin execution.
# It receives config from KIC via admin API — no direct Konnect connection.

image:
  repository: kong/kong-gateway   # Enterprise image (license managed by Konnect via KIC)
  tag: "3.9"

ingressController:
  enabled: false  # KIC is deployed as a separate Helm release

env:
  database: "off"   # DB-less — KIC pushes config via admin API
  # No Konnect env vars — KIC handles all Konnect communication

# Admin API — must stay enabled for KIC gateway discovery (ClusterIP only)
admin:
  enabled: true
  type: ClusterIP
  http:
    enabled: true
    containerPort: 8001

# Proxy — Kong Gateway listens for incoming traffic
# NLB is Terraform-managed for CloudFront VPC Origin integration
# Kong pods registered via TargetGroupBinding CRD (AWS LB Controller)
proxy:
  enabled: true
  type: ClusterIP    # NLB is Terraform-managed, not auto-created
  http:
    enabled: true
    containerPort: 8000
    servicePort: 80
  tls:
    enabled: true
    containerPort: 8443
    servicePort: 443

# Readiness probe: use /status instead of /status/ready
# DB-less Kong without initial config returns 503 on /status/ready,
# preventing KIC from discovering pods via admin API.
readinessProbe:
  httpGet:
    path: /status
    port: status
    scheme: HTTP

# Status endpoint (health checks — NLB health check target)
status:
  enabled: true
  http:
    enabled: true
    containerPort: 8100

resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 512Mi

tolerations:
  - key: "CriticalAddonsOnly"
    operator: "Exists"
    effect: "NoSchedule"

podDisruptionBudget:
  enabled: true
  minAvailable: 1

replicaCount: 2

# ==============================================================================
# KIC CONTROLLER VALUES (argocd/apps/02b-kong-controller.yaml)
# ==============================================================================
# The KIC controller watches K8s Gateway API CRDs (Gateway, HTTPRoute, etc.)
# and KongPlugin/KongConsumer CRDs, then:
#   1. Pushes config to Kong data plane via admin API (gatewayDiscovery)
#   2. Syncs config to Konnect (routes, plugins, consumers, node registration)
#   3. Fetches Enterprise license from Konnect
#   Note: KIC does NOT send traffic analytics to Konnect. Native Konnect
#   analytics require role=data_plane on the proxy, which is incompatible
#   with the gateway discovery pattern. Use Prometheus plugin instead.
#
# KIC is the ONLY component that connects to Konnect for KIC-type CPs.

# ingressController:
#   enabled: true
#   konnect:
#     enabled: true
#     runtimeGroupID: "<CP-ID>"                    # Control Plane ID (UUID)
#     apiHostname: "<REGION>.kic.api.konghq.com"   # KIC API endpoint
#     tlsClientCertSecretName: "kong-cluster-cert"  # mTLS cert for Konnect auth
#     license:
#       enabled: true                               # Auto-fetch Enterprise license
#   gatewayDiscovery:
#     enabled: true
#     adminApiService:
#       name: "kong-gateway-kong-admin"   # Data plane admin service name
#       namespace: "kong"
